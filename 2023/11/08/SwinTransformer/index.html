<!DOCTYPE html><html lang="zh-cn" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>SwinTransformer</title><meta name="keywords" content="深度学习"><meta name="author" content="AI4Future"><meta name="copyright" content="AI4Future"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="1、简介Swin Transformer是2012年微软研究院在ICCV上发表的一篇文章， 并荣获2021 ICCV最佳论文称号。 Swin Transformer网络是Transformer模型在视觉领域的又一次碰撞。  论文名称：Swin Transformer: Hierarchical Vision Transformer using Shifted Windows 论文地址： Swi">
<meta property="og:type" content="article">
<meta property="og:title" content="SwinTransformer">
<meta property="og:url" content="https://guudman.github.io/2023/11/08/SwinTransformer/index.html">
<meta property="og:site_name" content="Ai4Future">
<meta property="og:description" content="1、简介Swin Transformer是2012年微软研究院在ICCV上发表的一篇文章， 并荣获2021 ICCV最佳论文称号。 Swin Transformer网络是Transformer模型在视觉领域的又一次碰撞。  论文名称：Swin Transformer: Hierarchical Vision Transformer using Shifted Windows 论文地址： Swi">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://gitee.com/guudman/blog_images/raw/master/top_image.jpg">
<meta property="article:published_time" content="2023-11-08T10:07:06.000Z">
<meta property="article:modified_time" content="2023-11-08T10:10:53.353Z">
<meta property="article:author" content="AI4Future">
<meta property="article:tag" content="深度学习">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://gitee.com/guudman/blog_images/raw/master/top_image.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://guudman.github.io/2023/11/08/SwinTransformer/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":500},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: {"limitCount":50,"languages":{"author":"Author: AI4Future","link":"Link: ","source":"Source: Ai4Future","info":"Copyright is owned by the author. For commercial reprints, please contact the author for authorization. For non-commercial reprints, please indicate the source."}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://fastly.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://fastly.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'SwinTransformer',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-11-08 18:10:53'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="Ai4Future" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="is-center"><div class="avatar-img"><img src="/img/avatar.jpg" onerror="onerror=null;src='https://gitee.com/guudman/blog_images/raw/master/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">AI4Future</div><div class="author-info__description">Not Only Look Once</div></div><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/GuudMan" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:2663017379@qq.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-clock"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/gedan"><i class="fa-fw fas fa-music"></i><span> 歌单</span></a></div><div class="menus_item"><a class="site-page" href="/artitalk"><i class="fa-fw fa fa-heartbeat"></i><span> 时光</span></a></div><div class="menus_item"><a class="site-page" href="/shuoba"><i class="fa-fw fas fa-comment-dots"></i><span> 说吧</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-tools"></i><span> 工具</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/google"><span> 镜像</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://json.xbyzs.cf"><span> Json格式化</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://draw.xbyzs.cf"><span> Draw画布</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://enkey.xbyzs.cf"><span> EnKey</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="not-top-img" id="page-header"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Ai4Future</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-clock"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/gedan"><i class="fa-fw fas fa-music"></i><span> 歌单</span></a></div><div class="menus_item"><a class="site-page" href="/artitalk"><i class="fa-fw fa fa-heartbeat"></i><span> 时光</span></a></div><div class="menus_item"><a class="site-page" href="/shuoba"><i class="fa-fw fas fa-comment-dots"></i><span> 说吧</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-tools"></i><span> 工具</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/google"><span> 镜像</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://json.xbyzs.cf"><span> Json格式化</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://draw.xbyzs.cf"><span> Draw画布</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://enkey.xbyzs.cf"><span> EnKey</span></a></li></ul></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav></header><main class="layout" id="content-inner"><div id="post"><div id="post-info"><h1 class="post-title">SwinTransformer</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2023-11-08T10:07:06.000Z" title="Created 2023-11-08 18:07:06">2023-11-08</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2023-11-08T10:10:53.353Z" title="Updated 2023-11-08 18:10:53">2023-11-08</time></span></div><div class="meta-secondline"></div></div></div><article class="post-content" id="article-container"><meta name="referrer" content="no-referrer">

<h4 id="1、简介"><a href="#1、简介" class="headerlink" title="1、简介"></a>1、简介</h4><p>Swin Transformer是2012年微软研究院在ICCV上发表的一篇文章， 并荣获2021 ICCV最佳论文称号。 Swin Transformer网络是Transformer模型在视觉领域的又一次碰撞。 </p>
<p>论文名称：Swin Transformer: Hierarchical Vision Transformer using Shifted Windows</p>
<p>论文地址： <a target="_blank" rel="noopener" href="https://arxiv.org/pdf/2103.14030v2.pdf">Swin Transformer</a></p>
<hr>
<h4 id="2、论文整体框架"><a href="#2、论文整体框架" class="headerlink" title="2、论文整体框架"></a>2、论文整体框架</h4><p>在正文开始之前， 先对比一下Swin transformer与Vision Transformers， 下图是swin Transformers文章中给出的图， 左边是Swin Transformers，右边是之前的Vision Transformers，通过对比可以发现有两点不同。</p>
<ol>
<li>Swin Transformers使用了之前类似卷积神经网络的层次化构建方法（Hierachical feature maps）, 比如特征图尺寸有对图像下采样4倍的， 8倍的以及16倍的， 这样的backbone有助于在此基础上构建目标检测， 实例分割等任务。 而之前的Vision Transformer中一开始就是直接下采样16倍， 后面的特征图也是维持这样的下采样率不变。 </li>
<li>在Swin Transformer中使用了Window Multi-Head Self-Attention(W-MSA)的概念， 比如在4倍下采样和8倍下采样中， 将特征图划分成多个不相交的区域（windows）， 并且Multi-Head Self-Attention只在每个窗口内进行， 相对于Vision Transformer中直接对整个特征图进行Multi-Head Self-Attention， 这样做的目的是能够减少计算量， 尤其在浅层特征图很大的时候。这样做虽然减少了计算量， 但是也会隔绝不同窗口之间的信息传递， 所以在论文中作者又提出Shifted Windows Multi-Head Self-Attention(SW-MSA)的概念， 通过该方法能够让信息在相邻的窗口中进行传递。 </li>
</ol>
<p><img src="https://gitee.com/guudman/blog_images/raw/master/image-20231107151900499.png" alt="image-20231107151900499"></p>
<p>接下来，简单看下原论文中给出的关于Swin Transformer网络的架构图， 通过图(a)可以看到整个架构的基本历程如下：</p>
<p><img src="https://gitee.com/guudman/blog_images/raw/master/image-20231107152115158.png" alt="image-20231107152115158"></p>
<p>首先将图片输入到Patch Partition模块中进行分块， 即每4×4相邻的像素为一个Patch, 然后再channel方向展平（flatten)。假设输入的是RGB三通道图片， 那么每个patch就有4×4=16个像素， 然后每个像素有R/G/B三个值， 所以展平后是16×3=48， 所以通过patch partition后图像shape由[H, W, 3]变成了[H/4, W/4, 48]。 然后通过Linear Embedding层对每个像素的channel数据做线性变换， 由48变成C， 即图像shape再由[H/4, W/4, 48]变成了[H/4 ,W/4, C]。 其实在源码中Patch Patittion和Linear Embedding就是直接通过一个卷积实现的， 和之前VisionTransformer中讲的Embedding层结构一模一样。 </p>
<p>然后通过四个Stage构建不同大小的特征图， 除了Stage1中先通过Linear Embedding层外， 其他三个都是先通过一个Patch Merging层进行下采样。 然后都是重复堆叠Swin Transformer Block。注意这里的Block有两种结构， 如图（b)所示， 这两种结构的不同之处在于一个使用了W-MSA结构， 一个使用了SW-MSA结构。 而且这两种结构都是成对使用的，先使用一个W-MSA结构再使用一个SW-MSA结构。 所以会发现堆叠SwinTransformer Block的次数都是偶数(成对使用)</p>
<p>最后对于分类网络， 还会接上一个Layer Norm层， 全局池化层以及全连接层得到最终输出。 </p>
<p>下面分别对Patch Merging , W-MSA, SW-MAS以及使用到的相对位置偏置(relative position bias)进行详解。 关于Swin Transformer Block中的MLP结构和Vision Transformer中的结构一样。</p>
<hr>
<h4 id="3、Patch-Merging详解"><a href="#3、Patch-Merging详解" class="headerlink" title="3、Patch Merging详解"></a>3、Patch Merging详解</h4><p>前面提到， 在每个Stage中首先经过一个Patch Mering层进行下采样(stage1除外). 如下图所示， 假设输入Patch Merging的是一个4×4大小的单通道特征图（feature map）， Patch Merging会将每个2×2的相邻像素划分为一个patch, 然后将每个patch中相同位置（同一颜色）像素拼接到一起就得到了4个feature map。接着将这四个feature map在深度方向进行concat拼接， 然后通过一个LayerNorm层， 最后通过一个全连接层在feature map的深度方向做线性变换， 将feature map的深度有C变成C/2, 通过这个简单的例子可以看出， 通过Patch Merging层后， feature map的高和宽会减半， 深度会翻倍。 </p>
<p> <img src="https://gitee.com/guudman/blog_images/raw/master/image-20231107182524433.png" alt="image-20231107182524433"></p>
<hr>
<h4 id="4、W-MSA详解"><a href="#4、W-MSA详解" class="headerlink" title="4、W-MSA详解"></a>4、W-MSA详解</h4><p>引入Windows Multi-Head Self-Attention（W-MSA)模块是为了减少计算量， 如下如所示， 左侧使用的是普通的Multi-Head Self-Attention（MSA)模块， 对于feature map中的每个像素（或称作token， patch)， 在Self-Attention计算过程中需要和所有的像素去计算， 但在图右侧， 在使用Windows Multi-Head Self-Attention （W-MSA)模块时， 首先将feature map按照MxM(例子中M=2)大小划分成一个个Windowns, 然后单独对每个windows内部进行Self-Attention。</p>
<p><img src="https://gitee.com/guudman/blog_images/raw/master/image-20231108103028326.png" alt="image-20231108103028326"></p>
<p>两者的计算量具体差多少呢？原论文中给出了下面两个公式， 这里忽略了Softmax的计算复杂度：</p>
<script type="math/tex; mode=display">
MSA = 4hwC^2 + 2(hw)^2C</script><script type="math/tex; mode=display">
W_MSA = 4hwC^2 + 2M^2hwC</script><p>h， w代表feature map的高度和宽度</p>
<p>C代表feature map的深度</p>
<p>M代表每个窗口（Windows）的大小</p>
<p>回顾一下Self-Attention的公式</p>
<script type="math/tex; mode=display">
Attentino(Q, K, V) = SoftMax(\frac{QK^T}{\sqrt(d)})V</script><hr>
<p>MSA模块计算量</p>
<p>对于feature map中的每个像素（或者称为token, patch)， 都要通过<script type="math/tex">W_q, W_k, W_v</script>生成对应的query(q)， key(q)以及value(v), 这里假设q, k, v的向量长度与feature map的深度C保持一致， 那么对应所有像素生成Q的过程如下式：</p>
<script type="math/tex; mode=display">
A^{hw\times C}.W_q^{C\times C}= Q^{hw\times C}</script><script type="math/tex; mode=display">A^{hw\times C}$$对所有像素（token)拼接在一起得到的矩阵(一共有hw个像素， 每个像素的深度为C)

$$W_q^{C \times C}$$为生成query的变换矩阵

$$Q^{hw\times C}$$对所有像素通过$$W_q^{C \times C}$$得到的query拼接后的矩阵

根据矩阵运算的计算量公式可以得到生成Q的计算量为$$hw \times C \times C$$， 生成K和V， 同理都是$$hwC^2$$,那么总共是$$3hwC^2$$。

接下来Q和$$K^T$$， 对应计算量为$$(hw)^2C$$:</script><p>Q^{hw \times C}.K^{T(c\times hw)}=X^{hw \ time hw}</p>
<script type="math/tex; mode=display">
接下来忽略除以$$\sqrt{d}$$以及softmax的计算量， 假设得到$$$A^{hw \times hw}$$ , 最后还要乘以V， 对应的计算量为 $$(hw)^2C</script><script type="math/tex; mode=display">
A^{hw \times hw}.V^{hw\times C}= B^{hw \times C}</script><p>那么对应单头的Self-Attention模块， 总共需要<script type="math/tex">3hwC^2 + (hw)^2C + (hw)^2C = 3hwC^2 + 2(hw)^2C</script>。而实际使用过程中， 使用的是多头的Multi-Head Self-Attention模块， 在之前的文章中尽显过实验对比， 多头注意力模块相比单头注意力模块的计算量仅多了最后一个融合矩阵<script type="math/tex">W_O</script>的计算量<script type="math/tex">hwC^2</script></p>
<script type="math/tex; mode=display">
B^{hw \times C}.W_O^{hw\times C}= O^{hw \times C}</script><p>所以总共加起来是：<script type="math/tex">4hwC^2 + 2(hw)^2C</script></p>
<hr>
<h4 id="5、W-MSA模块计算量"><a href="#5、W-MSA模块计算量" class="headerlink" title="5、W-MSA模块计算量"></a>5、W-MSA模块计算量</h4><p>对于W-MSA模块首先要将feature map划分到一个窗口（windows)中， 假设每个窗口的高宽都是M， 那么总共会得到<script type="math/tex">\frac{h}{M} \times \frac{w}{M}</script>, 对于每个窗口内使用多头注意力模块， 刚刚计算高为h， 宽为w， 深度为C的feature map的计算量为<script type="math/tex">4hwC^2 + 2(hw)^2C</script>, 这里每个窗口的高为M， 宽为M， 带人公式得：</p>
<script type="math/tex; mode=display">
4(MC)^2 + 2(M)^4C</script><p>又因为有<script type="math/tex">\frac{h}{M} \times \frac{w}{M}</script>个窗口， 则：</p>
<script type="math/tex; mode=display">
\frac{h}{M} \times \frac{w}{M} \times (4(MC)^2 + 2(M)^4C = 4hwC^2 + 2M^2hwc</script><p>故使用W-MAS模块的计算量为：<script type="math/tex">4hwC^2 + 2M^2hwc</script></p>
<p>假设feature map的h， w都是112， M=7， C=112, 采用W-MSA模块相比MSA模块能够减少40124743680FLOPs</p>
<script type="math/tex; mode=display">
2(hw)^2C - 2M^2hwc = 2 \times 112 ^ 4 \times 128 - 2 \times 7^2 \times 112^2 \times 128 = 40124743680</script><hr>
<h4 id="6、SW-MAS详解"><a href="#6、SW-MAS详解" class="headerlink" title="6、SW-MAS详解"></a>6、SW-MAS详解</h4><p>采用W-MSA模块时， 只会在每个窗口内进行注意力计算， 所以窗口与窗口之间是无法进行消息传递的。 为了解决这问题， 作者引入了shifted windows Multi-Head Self-Attention（SW-MSA)模块， 即进行偏移的W-MSA。如下图所示， 左侧使用的是刚刚讲的W-MSA(假设是第L层), 那么根据之前介绍的W-SMA和SW-MAS是称帝使用的， 那么第L+1层使用的就是SW-MSA(右侧图)。 根据左右两幅图对比能够发信啊窗口发生了偏移（可以理解为创库从左上角分别向右侧和下方各偏移了<script type="math/tex">[\frac{M}{2}]</script>个像素)。 看下偏移后的窗口， 比如对于第一行第2列的2x4的窗口， 它能够使用第L层的第一排的两个窗口信息进行交流。 再比如， 第二行第二列的4x4的窗口， 它能够使第L层的四个窗口信息进行交流， 其他的同理， 那么这就解决了不同窗口之间无法进行信息交流的问题。 </p>
<p><img src="https://gitee.com/guudman/blog_images/raw/master/image-20231108114622550.png" alt="image-20231108114622550"></p>
<p>根据上图， 可以发现通过将窗口进行偏移后， 由原来的4个窗口变成9个窗口了， 后面又要对每个窗口内部进行MSA， 这样做感觉又变麻烦了， 为解决这个麻烦， 作者又提出了Efficient batch computation for shifted configuration， 一种更加高效的计算方法， 下面是原论文给出的示意图。 </p>
<p><img src="https://gitee.com/guudman/blog_images/raw/master/image-20231108114945850.png" alt="image-20231108114945850"></p>
<p>为更好的解释， 作如下示意图， 下图左侧是刚刚通过偏移窗口后得到的新窗口， 右侧是为了方便大家理解， 在每个窗口上加 另一个标识， 然后0对应的窗口表示区域为A， 3和6对应的窗口标记区域为B， 1和2对应的窗口标记为区域C。 </p>
<p><img src="https://gitee.com/guudman/blog_images/raw/master/image-20231108141757256.png" alt="image-20231108141757256"></p>
<p>将A和C移到最下方</p>
<p><img src="https://gitee.com/guudman/blog_images/raw/master/image-20231108141834985.png" alt="image-20231108141834985"></p>
<p>然后再将A和B移到最右侧</p>
<p><img src="https://gitee.com/guudman/blog_images/raw/master/image-20231108142740693.png" alt="image-20231108142740693"></p>
<p>移动完成后，4是一个单独的窗口， 将5和3合并到一起， 7和1合并成一个窗口， 8， 6， 2， 0合并成一个窗口。 这样又和原来一样是4个4×4的窗口了。 所以保证计算量是一样的。 这里肯定会有人疑惑， 把不同的区域合并在一起（比如5和3）进行Multi-Head Self-Attention，这信息不就乱窜了吗？是的， 为了放置这个问题， 实际计算中使用的是masked MSA即带蒙板mask的Multi-Head Self-Attention， 这样就能够设置蒙板来隔绝不同区域的信息了。 关于mask如何使用， 可以看下图， 下图以上图的区域5和区域3为例。 </p>
<p><img src="https://gitee.com/guudman/blog_images/raw/master/image-20231108144754091.png" alt="image-20231108144754091"></p>
<p>对于该窗口内的每一个像素（或称token， patch）在进行Multi-Head Self-Attention计算时， 都要先生成对应的query(q), key(k), value(v)。 假设对于上图的像素0而言， 得到<script type="math/tex">q^0</script>后要与每一个像素的k进行匹配（match）， 假设<script type="math/tex">a_{0,0}</script>代表<script type="math/tex">q^0</script>与像素0对应的<script type="math/tex">k^0</script>进行匹配的结果， 那么同理可以得到<script type="math/tex">a_{0, 0}</script>至<script type="math/tex">a_{0, 15}</script>。按照普通的MSA计算， 接下来就是Softmax操作了， 但对于这里的masked Multi-Head Self-Attention， 像素0属于区域5的， 我们只想让它和区域5的像素进行匹配。那么将像素0与区域3中的所有像素匹配结果都减去100（例如<script type="math/tex">a_{0, 2}, a_{0, 3}, a_{0, 6}, a_{0,7}</script>等等）。 由于<script type="math/tex">\alpha</script>的值很小， 一般都是零点几的数， 将其中一些数减去100后再通过softmax得到对应的权重都等于0了。 所以对于像素0而言实际上还是只和区域5内的像素进行了Multi-Head Self-Attention， 那么对于其他像素也是同理。 <strong>注意，在计算完后还要把数据给挪回到原来的位置上（例如上述的A, B, C区域</strong></p>
<hr>
<h4 id="7、Relative-Position-Bias详解"><a href="#7、Relative-Position-Bias详解" class="headerlink" title="7、Relative Position Bias详解"></a>7、Relative Position Bias详解</h4><p>关于相对位置偏置， 论文中没有细讲， 只是说使用了相对位置偏置后能够带来明显的提升。 </p>
<p><img src="https://gitee.com/guudman/blog_images/raw/master/image-20231108150114591.png" alt="image-20231108150114591"></p>
<p>相对位置偏置是如何使用的，论文中提供了如下的公式：</p>
<script type="math/tex; mode=display">
Attention(Q, K, V) = SoftMax(\frac{QK^T}{\sqrt{d} +B})V</script><p>由于论文中并没有详细讲解这个相对位置偏置， 所以根据阅读源码做了简单的总结。 如下图， 假设输入的feature map高和宽都是2， 那么首先可以通过构建每个像素的相对位置（左下方的矩阵）， 对于每个像素的绝对位置是使用行号和列号表示。 比如蓝色的像素对应的是第0行和第0列， 所以绝对位置索引是（0， 0）。</p>
<p>下面来看相对位置索引， 首先看蓝色的像素， 在蓝色像素使用q与所有像素k进行匹配过程中， 是以蓝色像素为参考点。然后使用蓝色像素的绝对位置索引与其他位置索引进行相减， 就得到其他位置相对于蓝色像素的<strong>相对位置索引</strong>。例如黄色像素的绝对位置索引是（0， 1）， 则它相对于蓝色像素的相对位置索引为（0， 0） - （0， 1）= （0， -1）。同理可以得到其他位置相对于蓝色像素的相对位置索引矩阵。 同样， 也能得到相对黄色， 红色以及绿色像素的相对位置索引矩阵。 接下来将每个相对位置索引矩阵<strong>按行展开</strong>， 并<strong>拼接</strong>在一起可以得到下面的4×4矩阵。 </p>
<p><img src="https://gitee.com/guudman/blog_images/raw/master/image-20231108153312906.png" alt="image-20231108153312906"></p>
<p>注意， 这里描述的都是<strong>相对位置所以</strong>， 并不是<strong>相对位置偏置参数</strong>。因为后面后面会根据相对位置索引去取对应的参数。比如黄色像素在蓝色像素的右边， 所以相对蓝色像素相对位置索引为（0， -1）。绿色像素在红色像素的右边， 所以相对红色像素的相对位置索引为（0,-1）。可以发现二者的相对位置索引都是（0， -1）， 所以它们使用相同的<strong>相对位置偏置参数</strong>。</p>
<p>在源码中作者为了方便吧二维索引转成一维索引， 具体怎么转的呢？， 简单的想法是直接把行、列索引相加不就可以变成一维了吗？比如上面的相对位置索引中有（0， -1）和（-1， 0）, 在二维的相对位置索引中明显代表不同的位置， 但如果简单相加都等于-1那不就出问题了吗， 下面看看源码中是怎么做到的。 首先在原始的相对位置索引上加上M-1（M为窗口的大小， 在本例中M=2）, 加上之后索引中就不会有负数了。 </p>
<p><img src="https://gitee.com/guudman/blog_images/raw/master/image-20231108154623062.png" alt="image-20231108154623062"></p>
<p>然后将所有的行标都乘以2M-1</p>
<p><img src="https://gitee.com/guudman/blog_images/raw/master/image-20231108154937473.png" alt="image-20231108154937473"></p>
<p>最后将行标和列标都相加， 这样即保证了相对位置关系， 而且不会出现上述0 + （-1） = （-1） + 0的问题了。 </p>
<p><img src="https://gitee.com/guudman/blog_images/raw/master/image-20231108155226820.png" alt="image-20231108155226820"></p>
<p>上面提到， 之前计算的是<strong>相对位置索引</strong>， 并不是<strong>相对位置偏置参数</strong>, 真正使用到的可训练参数B保存在relative position bias table表中的额， 这个表的长度等于（2M-1)×(2M-1)的。 那么上述公式中的相对位置偏置参数B是根据上面的相对位置索引表查relative position bias table表得到的。 如下图所示。 </p>
<p><img src="https://gitee.com/guudman/blog_images/raw/master/image-20231108160222893.png" alt="image-20231108160222893"></p>
<hr>
<h4 id="8、模型配置参数"><a href="#8、模型配置参数" class="headerlink" title="8、模型配置参数"></a>8、模型配置参数</h4><p>回顾一下swin-transformer的网络架构</p>
<p><img src="https://gitee.com/guudman/blog_images/raw/master/image-20231107152115158.png" alt="image-20231107152115158"></p>
<p>下表是原论文给出的关于不同swin Transformers的配置， T（tiny）， S（small), B(Base), L(Large)， 其中：</p>
<p>win. sz. 7×7表示使用的窗口（Windows)的大小</p>
<p>dim表示feature map的channel深度（或者说token的向量长度）</p>
<p>head表示多头注意力模块中head的个数</p>
<p><img src="https://gitee.com/guudman/blog_images/raw/master/image-20231108160608602.png" alt="image-20231108160608602"></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">AI4Future</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://guudman.github.io/2023/11/08/SwinTransformer/">https://guudman.github.io/2023/11/08/SwinTransformer/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post_share"><div class="social-share" data-image="https://gitee.com/guudman/blog_images/raw/master/top_image.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://fastly.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/11/09/DeepLab-V1/"><img class="prev-cover" src="https://gitee.com/guudman/blog_images/raw/master/top_image.jpg" onerror="onerror=null;src='https://gitee.com/guudman/blog_images/raw/master/article.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">DeepLab_V1</div></div></a></div><div class="next-post pull-right"><a href="/2023/11/07/TransposeConv/"><img class="next-cover" src="https://gitee.com/guudman/blog_images/raw/master/top_image.jpg" onerror="onerror=null;src='https://gitee.com/guudman/blog_images/raw/master/article.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">TransposeConv</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><div><a href="/2023/11/02/AlexNet%E8%A7%A3%E6%9E%90/" title="AlexNet解析"><img class="cover" src="https://gitee.com/guudman/blog_images/raw/master/top_image.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-11-02</div><div class="title">AlexNet解析</div></div></a></div><div><a href="/2023/11/04/BatchNormalization/" title="BatchNormalization"><img class="cover" src="https://gitee.com/guudman/blog_images/raw/master/top_image.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-11-04</div><div class="title">BatchNormalization</div></div></a></div><div><a href="/2023/11/12/ConvNeXt/" title="ConvNeXt"><img class="cover" src="https://gitee.com/guudman/blog_images/raw/master/top_image.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-11-12</div><div class="title">ConvNeXt</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%E3%80%81%E7%AE%80%E4%BB%8B"><span class="toc-number">1.</span> <span class="toc-text">1、简介</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%E3%80%81%E8%AE%BA%E6%96%87%E6%95%B4%E4%BD%93%E6%A1%86%E6%9E%B6"><span class="toc-number">2.</span> <span class="toc-text">2、论文整体框架</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3%E3%80%81Patch-Merging%E8%AF%A6%E8%A7%A3"><span class="toc-number">3.</span> <span class="toc-text">3、Patch Merging详解</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4%E3%80%81W-MSA%E8%AF%A6%E8%A7%A3"><span class="toc-number">4.</span> <span class="toc-text">4、W-MSA详解</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5%E3%80%81W-MSA%E6%A8%A1%E5%9D%97%E8%AE%A1%E7%AE%97%E9%87%8F"><span class="toc-number">5.</span> <span class="toc-text">5、W-MSA模块计算量</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6%E3%80%81SW-MAS%E8%AF%A6%E8%A7%A3"><span class="toc-number">6.</span> <span class="toc-text">6、SW-MAS详解</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7%E3%80%81Relative-Position-Bias%E8%AF%A6%E8%A7%A3"><span class="toc-number">7.</span> <span class="toc-text">7、Relative Position Bias详解</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8%E3%80%81%E6%A8%A1%E5%9E%8B%E9%85%8D%E7%BD%AE%E5%8F%82%E6%95%B0"><span class="toc-number">8.</span> <span class="toc-text">8、模型配置参数</span></a></li></ol></div></div><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/avatar.jpg" onerror="this.onerror=null;this.src='https://gitee.com/guudman/blog_images/raw/master/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">AI4Future</div><div class="author-info__description">Not Only Look Once</div></div><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/GuudMan" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:2663017379@qq.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>Announcement</span></div><div class="announcement_content">微信公众号: 预留，暂未开通</div></div></div></div></main><footer id="footer" style="background: #FFFFFF"><div id="footer-wrap"><div class="copyright">&copy;2022 - 2023 By AI4Future</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/chenxz21/hexo-theme-bcxm">Bcxm</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="darkmode" type="button" title="Toggle Between Light And Dark Mode"><i class="fas fa-adjust"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://fastly.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.js"></script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [ ['$','$'], ["\\(","\\)"]],
      tags: 'ams'
    },
    chtml: {
      scale: 1.2
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, ''],
        insertScript: [200, () => {
          document.querySelectorAll('mjx-container:not\([display]\)').forEach(node => {
            const target = node.parentNode
            if (target.nodeName.toLowerCase() === 'li') {
              target.parentNode.classList.add('has-jax')
            } else {
              target.classList.add('has-jax')
            }
          });
        }, '', false]
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://fastly.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typeset()
}</script></div><script type="text/javascript" src="https://fastly.jsdelivr.net/npm/leancloud-storage@4.10.0/dist/av-min.js"></script><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://fastly.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-nest.min.js"></script><script id="click-heart" src="https://fastly.jsdelivr.net/npm/butterfly-extsrc@1/dist/click-heart.min.js" async="async" mobile="false"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>